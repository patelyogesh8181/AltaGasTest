name: Deploy AltaGasTest (Blazor WASM + API) to EC2

on:
  push:
    branches: ["main"]

concurrency:
  group: altagastest-ec2
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      DOTNET_VERSION: "8.0.x"
      WEB_PROJECT: "AltaGasTest.Web/AltaGasTest.Web.csproj"
      API_PROJECT: "AltaGasTest.API/AltaGasTest.API.csproj"

      PUBLISH_WEB: "publish_web"
      PUBLISH_API: "publish_api"

      REMOTE_WEB_DIR: "/var/www/altagastest-web"
      REMOTE_API_DIR: "/opt/altagastest-api"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore
        run: dotnet restore

      - name: Publish API (Release)
        run: dotnet publish ${{ env.API_PROJECT }} -c Release -o ${{ env.PUBLISH_API }}

      - name: Publish Blazor WASM (Release)
        run: dotnet publish ${{ env.WEB_PROJECT }} -c Release -o ${{ env.PUBLISH_WEB }}

      - name: Install SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy API to EC2
        run: |
          rsync -avz --delete \
            "${{ env.PUBLISH_API }}/" \
            "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ env.REMOTE_API_DIR }}/"

      - name: Deploy Blazor WASM wwwroot to EC2
        run: |
          rsync -avz --delete \
            "${{ env.PUBLISH_WEB }}/wwwroot/" \
            "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ env.REMOTE_WEB_DIR }}/"

      - name: Restart API and reload Nginx
        run: |
          ssh "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" "
            sudo systemctl restart altagastest-api &&
            sudo nginx -t &&
            sudo systemctl reload nginx
          "
